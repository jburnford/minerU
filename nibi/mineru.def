Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-devel-rockylinux9

%environment
    export TZ=UTC
    export PIP_NO_CACHE_DIR=1
    export CMAKE_BUILD_PARALLEL_LEVEL=8
    export TORCH_CUDA_ARCH_LIST="8.0;8.6;8.9;9.0"
    export CUDA_HOME=/usr/local/cuda
    export FORCE_CUDA=1
    export PATH=/root/.local/bin:/usr/local/cuda/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

    # Default I/O locations (configurable via env)
    export INPUT_PATH=/workspace/input
    export OUTPUT_PATH=/workspace/output
    export NUM_WORKERS=16
    export MINERU_CMD=mineru

%post
    # Update system packages (Rocky Linux uses dnf/yum)
    dnf install -y epel-release
    dnf install -y \
        git curl ca-certificates wget gcc gcc-c++ make pkgconfig \
        python3 python3-devel \
        tesseract tesseract-langpack-eng \
        poppler-utils ghostscript \
        mesa-libGL mesa-libGL-devel glib2 glib2-devel \
        google-noto-sans-fonts \
        && dnf clean all

    # Install pip using Python's built-in ensurepip (avoids DNF conflicts)
    python3 -m ensurepip --upgrade

    # Upgrade pip and install base packages (use python3 -m pip for reliability)
    python3 -m pip install --upgrade pip setuptools wheel

    # Install PyTorch CUDA build (12.1 wheels)
    python3 -m pip install --extra-index-url https://download.pytorch.org/whl/cu121 \
        torch torchvision torchaudio

    # Install ONNX Runtime GPU (optional, for some pipelines)
    python3 -m pip install onnx onnxruntime-gpu==1.18.0 || true

    # Install uv using official standalone installer (official MinerU recommendation)
    curl -LsSf https://astral.sh/uv/install.sh | sh

    # Add uv to PATH for this build session
    export PATH="/root/.local/bin:$PATH"

    # Install MinerU using uv (official method)
    uv pip install --system -U "mineru[core]"

    # Create workspace directories
    mkdir -p /workspace/input /workspace/output

%runscript
    exec python3 -c "import sys; print('MinerU container ready. Use mineru command to process documents.')"

%labels
    Author jic823
    Version 2.0
    Description MinerU container for Nibi H100 cluster (official opendatalab version)

%help
    This container provides MinerU for advanced PDF/document processing.
    Official repository: https://github.com/opendatalab/MinerU

    Usage:
        apptainer exec --nv mineru.sif mineru [options]

    Example:
        apptainer exec --nv mineru.sif mineru \
            -p /path/to/input.pdf \
            -o /path/to/output
